<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Пошаговая форма</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .form-container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 600px;
            padding: 30px;
            position: relative;
            overflow: hidden;
        }

        .form-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .form-header h2 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .form-header p {
            color: #7f8c8d;
            font-size: 18px;
        }

        .form-step {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .form-step.active {
            display: block;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #34495e;
            font-size: 18px;
        }

        .form-control, .form-select {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-control:focus, .form-select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .btn-container {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 16px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-next {
            background-color: #3498db;
            color: white;
            border: none;
        }

        .btn-next:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn-prev {
            background-color: #ecf0f1;
            color: #2c3e50;
            border: none;
        }

        .btn-prev:hover {
            background-color: #d5dbdb;
        }

        .btn-submit {
            background-color: #2ecc71;
            color: white;
            border: none;
            width: 100%;
        }

        .btn-submit:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }

        .progress-container {
            margin-bottom: 30px;
        }

        .progress {
            height: 10px;
            border-radius: 5px;
            background-color: #ecf0f1;
            overflow: visible;
        }

        .progress-bar {
            background-color: #3498db;
            transition: width 0.5s ease;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #7f8c8d;
            position: relative;
        }

        .step.active {
            background-color: #3498db;
            color: white;
        }

        .step.completed {
            background-color: #2ecc71;
            color: white;
        }

        .step-label {
            position: absolute;
            top: 35px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            color: #7f8c8d;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-option:hover {
            border-color: #3498db;
            background-color: #f8f9fa;
        }

        .radio-option.selected {
            border-color: #3498db;
            background-color: #e1f0fa;
        }

        .radio-option input {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .radio-option label {
            cursor: pointer;
            font-size: 16px;
            flex-grow: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .success-message {
            text-align: center;
            padding: 30px;
        }

        .success-icon {
            font-size: 60px;
            color: #2ecc71;
            margin-bottom: 20px;
        }

        .success-message h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .success-message p {
            color: #7f8c8d;
            font-size: 18px;
            margin-bottom: 25px;
        }

        .spinner-border {
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            vertical-align: text-bottom;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }

        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }

        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        
        /* Стили для нерабочих дней */
        .flatpickr-day.disabled {
            color: #ccc;
            text-decoration: line-through;
            cursor: not-allowed;
        }
        
        /* Кастомизация календаря */
        .flatpickr-calendar {
            font-family: inherit;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
    </style>    
</head>
<body>
    <div class="form-container">
        <div class="form-header">
            <h2>Запись в комнату психологической разгрузки</h2>
            <p>Заполните форму шаг за шагом</p>
        </div>
        
        <div class="progress-container">
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            <div class="step-indicator">
                <div class="step active" data-step="1"><span>1</span><div class="step-label">ФИО</div></div>
                <div class="step" data-step="2"><span>2</span><div class="step-label">Телефон</div></div>
                <div class="step" data-step="3"><span>3</span><div class="step-label">Должность</div></div>
                <div class="step" data-step="4"><span>4</span><div class="step-label">Дата</div></div>
                <div class="step" data-step="5"><span>5</span><div class="step-label">Время</div></div>
                <div class="step" data-step="6"><span>6</span><div class="step-label">Комментарий</div></div>
            </div>
        </div>
        
        <form id="step-form">
            <!-- Шаг 1: ФИО -->
            <div class="form-step active" data-step="1">
                <div class="form-group">
                    <label class="form-label" for="fullname">
                        <i class="bi bi-person form-icon"></i>Ваше ФИО
                    </label>
                    <input type="text" name="fullname" class="form-control" id="fullname" placeholder="Иванов Иван Иванович" required>
                </div>
                <div class="btn-container">
                    <a href="/" class="btn btn-prev">Назад</a>
                    <button type="button" class="btn btn-next" data-next="2">Далее</button>
                </div>
            </div>
            
            <!-- Шаг 2: Телефон -->
            <div class="form-step" data-step="2">
                <div class="form-group">
                    <label class="form-label" for="phone">
                        <i class="bi bi-telephone form-icon"></i>Ваш номер телефона
                    </label>
                    <input type="tel" name="phone" class="form-control" maxlength="11" id="phone" placeholder="8 (900) 123-45-67" inputmode="numeric" oninput="this.value = this.value.replace(/\D/g, '')" required>
                </div>
                <div class="btn-container">
                    <button type="button" class="btn btn-prev" data-prev="1">Назад</button>
                    <button type="button" class="btn btn-next" data-next="3">Далее</button>
                </div>
            </div>
            
            <!-- Шаг 3: Должность -->
            <div class="form-step" data-step="3">
                <div class="form-group">
                    <label class="form-label">
                        <i class="bi bi-briefcase form-icon"></i>Ваша должность
                    </label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio"  id="junior" name="position" value="Младший мед. персонал">
                            <label for="manager">Младший мед. персонал</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="middle" name="position" value="Средний мед. персонал">
                            <label for="developer">Средний мед. персонал</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="doctor" name="position" value="Врач">
                            <label for="designer">Врач</label>
                        </div>
                        <!-- <div class="radio-option">
                            <input type="radio" id="sister" name="position" value="Мед. сестра">
                            <label for="analyst">Мед. сестра</label>
                        </div> -->
                        <div class="radio-option">
                            <input type="radio" id="administration" name="position" value="Администрация">
                            <label for="director">Администрация</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="other" name="position" value="Другое">
                            <label for="director">Другое</label>
                        </div>
                    </div>
                </div>
                <div class="btn-container">
                    <button type="button" class="btn btn-prev" data-prev="2">Назад</button>
                    <button type="button" class="btn btn-next" data-next="4">Далее</button>
                </div>
            </div>

            <!-- Шаг 4: Дата -->
            <div class="form-step" data-step="4">
                <div class="form-group">
                    <label class="form-label" for="date">
                        <i class="bi bi-calendar form-icon"></i>Выберите дату
                    </label>
                    <input type="text" name="date" class="form-control" id="date" readonly required>
                </div>
                <div class="btn-container">
                    <button type="button" class="btn btn-prev" data-prev="3">Назад</button>
                    <button type="button" class="btn btn-next" data-next="5">Далее</button>
                </div>
            </div>
            
            <!-- Шаг 5: Время -->
            <div class="form-step" data-step="5">
                <div class="form-group">
                    <label class="form-label" for="time">
                        <i class="bi bi-clock form-icon"></i>Выберите время
                        <p>Длительность сессии 25 минут</p>
                    </label>
                    <select class="form-select" id="time" required>
                    </select>
                </div>
                <div class="btn-container">
                    <button type="button" class="btn btn-prev" data-prev="4">Назад</button>
                    <button type="button" class="btn btn-next" data-next="6">Далее</button>
                </div>
            </div>
     
            <!-- Шаг 6: Комментарий -->
            <div class="form-step" data-step="6">
                <div class="form-group">
                    <label class="form-label" for="comment">
                        <i class="bi bi-chat-dots form-icon"></i>Дополнительный комментарий
                    </label>
                    <textarea class="form-control" id="comment" rows="4" placeholder="Опишите детали вашего запроса..."></textarea>
                </div>
                <div class="btn-container">
                    <button type="button" class="btn btn-prev" data-prev="5">Назад</button>
                    <button type="submit" class="btn btn-submit">Отправить</button>
                </div>
            </div>
            
            <!-- Шаг 7: Успешное завершение -->
            <div class="form-step success-message" data-step="7">
                <div class="success-icon">
                    <i class="bi bi-check-circle"></i>
                </div>
                <h3>Форма успешно отправлена!</h3>
                <p>Спасибо за ваше обращение. Мы свяжемся с вами в ближайшее время.</p>
                <button type="button" class="btn btn-submit" id="restart-btn">Заполнить новую форму</button>
            </div>
        </form>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Текущий шаг
            let currentStep = 1;
            const totalSteps = 6;
            let times = [];

            fetch('/slots_room/days')
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.status !== 'success') throw new Error('Invalid response format');
                    console.log(data)
                    // Создаем массив активных дней недели (0-воскресенье, 1-понедельник и т.д.)
                    const activeDays = data.days
                        .filter(day => day.is_active)
                        .map(day => {
                            const daysMap = {
                                'sunday': 0,
                                'monday': 1,
                                'tuesday': 2,
                                'wednesday': 3,
                                'thursday': 4,
                                'friday': 5,
                                'saturday': 6
                            };
                            return daysMap[day.day.toLowerCase()];
                        });
                    console.log(activeDays)
                    
                    // Инициализация календаря после получения данных
                    const datePicker = flatpickr("#date", {
                        minDate: "today",
                        maxDate: new Date().fp_incr(90), // +3 месяца
                        disable: [
                            function(date) {
                                // Отключаем все дни, которых нет в activeDays
                                return !activeDays.includes(date.getDay());
                            }
                        ],
                        locale: "ru",
                        dateFormat: "Y-m-d",
                        onChange: function(selectedDates) {
                            console.log("Выбрана дата:", selectedDates[0]);
                        },
                        onDayCreate: function(dObj, dStr, fp, dayElem) {
                            // Помечаем рабочие дни
                            if (activeDays.includes(dayElem.dateObj.getDay())) {
                                dayElem.classList.add("work-day");
                            }
                        }
                    });
                    
                })
                .catch(error => {
                    console.error('Error loading active days:', error);
                    alert('Не удалось загрузить доступные дни. Пожалуйста, попробуйте позже.');
                    
                    // Фолбэк - базовый календарь если API не отвечает
                    flatpickr("#date", {
                        minDate: "today",
                        maxDate: new Date().fp_incr(90),
                        locale: "ru",
                        dateFormat: "Y-m-d"
                    });
                });

            // Элементы DOM
            const form = document.getElementById('step-form');
            const progressBar = document.querySelector('.progress-bar');
            const prevButtons = document.querySelectorAll('.btn-prev');
            const nextButtons = document.querySelectorAll('.btn-next');
            const steps = document.querySelectorAll('.step');
            const formSteps = document.querySelectorAll('.form-step');
            const restartBtn = document.getElementById('restart-btn');
            
            // Радио кнопки
            const radioOptions = document.querySelectorAll('.radio-option');
            radioOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Убираем выделение у всех опций
                    radioOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // Добавляем выделение к выбранной опции
                    this.classList.add('selected');
                    
                    // Ставим отметку на радио кнопке
                    const radioInput = this.querySelector('input');
                    radioInput.checked = true;
                });
            });
            
            // Обновление индикатора прогресса
            function updateProgress() {
                const progressPercent = ((currentStep - 1) / totalSteps) * 100;
                progressBar.style.width = progressPercent + '%';
                
                // Обновление шагов
                steps.forEach(step => {
                    const stepNum = parseInt(step.dataset.step);
                    step.classList.remove('active', 'completed');
                    
                    if (stepNum === currentStep) {
                        step.classList.add('active');
                    } else if (stepNum < currentStep) {
                        step.classList.add('completed');
                    }
                });
            }

            
            // Переход к шагу
            function goToStep(step) {
                // Скрываем все шаги
                formSteps.forEach(formStep => {
                    formStep.classList.remove('active');
                });
                
                // Показываем текущий шаг
                document.querySelector(`.form-step[data-step="${step}"]`).classList.add('active');
                
                currentStep = step;
                updateProgress();
            }
            
            // Навигация вперед
            nextButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const nextStep = parseInt(this.dataset.next);
                    
                    // Проверка заполнения текущего шага
                    let isValid = true;
                    
                    if (nextStep === 2) {
                        const fullname = document.getElementById('fullname').value;
                        if (!fullname.trim()) {
                            alert('Пожалуйста, введите ваше ФИО');
                            isValid = false;
                        }
                    } else if (nextStep === 3) {
                        const phone = document.getElementById('phone').value;
                        if (!phone.trim()) {
                            alert('Пожалуйста, введите ваш номер телефона');
                            isValid = false;
                        }
                    } else if (nextStep === 4) {
                        const positionSelected = document.querySelector('input[name="position"]:checked');
                        if (!positionSelected) {
                            alert('Пожалуйста, выберите вашу должность');
                            isValid = false;
                        }
                    } else if (nextStep === 5) {
                        const date = document.getElementById('date').value;
                        const timeSelect = document.getElementById('time');
                        if (!date) {
                            alert('Пожалуйста, выберите дату');                    
                            isValid = false;
                        }

                        fetch('/available-times-room?'+
                            new URLSearchParams({ date: date}).toString()).then(response => {
                                if (!response.ok) throw new Error('Ошибка сети');
                                return response.json();
                            })
                            .then(json => {
                                console.log(json);
                                const availableTimes = json; 
                                timeSelect.innerHTML = '';
                                if (availableTimes.length === 0) {
                                    timeSelect.innerHTML = '<option value="" disabled>Нет доступных окон</option>';
                                } else {
                                
                                    const defaultOption = document.createElement('option');
                                    defaultOption.value = "";
                                    defaultOption.disabled = true;
                                    defaultOption.selected = true;
                                    defaultOption.textContent = "Выберите время";
                                    timeSelect.appendChild(defaultOption);
                                    
                                    
                                    availableTimes.forEach(time => {
                                        const option = document.createElement('option');
                                        option.value = time;
                                        option.textContent = time;
                                        timeSelect.appendChild(option);
                                    });
                                    
                                    timeSelect.disabled = false;
                                }
                            })
                            .catch(error => {
                                console.error('Ошибка:', error);
                            });
    
                    } else if (nextStep === 6) {
                        const time = document.getElementById('time').value;
                        if (!time) {
                            alert('Пожалуйста, выберите время');
                            isValid = false;
                        }
                    }
                    
                    if (isValid) {
                        goToStep(nextStep);
                    }
                });
            });
            
            // Навигация назад
            prevButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const prevStep = parseInt(this.dataset.prev);
                    goToStep(prevStep);
                });
            });
            
            // Отправка формы
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Собираем данные формы
                const formData = {
                    fio: document.getElementById('fullname').value,
                    phone: document.getElementById('phone').value,
                    position: document.querySelector('input[name="position"]:checked')?.value || '',
                    type: "Комната психологической разгрузки",
                    comment:document.getElementById('comment').value,
                    meet_date: document.getElementById('date').value,
                    meet_time: document.getElementById('time').value
                };

                // Отправляем POST-запрос
                fetch('/event', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка сети');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Успешно:', data);
                    goToStep(7);
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Произошла ошибка при отправке формы');
                });
            });
            
            
            restartBtn.addEventListener('click', function() {
                
                form.reset();
                
                radioOptions.forEach(opt => opt.classList.remove('selected'));
                
                goToStep(1);
            });
            
            updateProgress();
        });
    </script>

</body>
</html>